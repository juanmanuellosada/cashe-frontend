import{aj as u,g as B,r as o,j as e,D as V}from"./index-CBBw_BsA.js";const R="15551632329",A=async()=>{const{data:{user:s},error:r}=await u.auth.getUser();if(r)throw console.error("Error getting user:",r),new Error("Error getting authenticated user");if(!s)throw new Error("No authenticated user");return s.id},H=async()=>{const s=await A(),{data:r,error:t}=await u.from("profiles").select("whatsapp_enabled, email, full_name").eq("id",s).single();return t?(console.error("Error checking WhatsApp access:",t),{enabled:!1,email:null,name:null}):{enabled:(r==null?void 0:r.whatsapp_enabled)===!0,email:r==null?void 0:r.email,name:r==null?void 0:r.full_name}},Y=async()=>{const s=await A(),{data:r,error:t}=await u.from("whatsapp_users").select("*").eq("user_id",s).maybeSingle();if(t)throw console.error("Error getting WhatsApp status:",t),t;if(!r)return{status:"not_linked",phone:null,verificationCode:null,linkedAt:null};if(r.verified)return{status:"linked",phone:r.phone_number,verificationCode:null,linkedAt:r.updated_at};const a=r.verification_expires_at&&new Date(r.verification_expires_at)<new Date;return{status:a?"code_expired":"pending_verification",phone:null,verificationCode:a?null:r.verification_code,expiresAt:r.verification_expires_at,linkedAt:null}},J=async()=>{const s=await A(),r=Math.floor(1e5+Math.random()*9e5).toString(),t=new Date(Date.now()+600*1e3).toISOString(),{data:a,error:n}=await u.from("whatsapp_users").upsert({user_id:s,phone_number:`pending_${s}`,verification_code:r,verification_expires_at:t,verified:!1,updated_at:new Date().toISOString()},{onConflict:"user_id",ignoreDuplicates:!1}).select().single();if(n)throw console.error("Error generating verification code:",n),n;return{code:r,expiresAt:t,expiresIn:600}},Q=async()=>{const s=await A(),{data:r,error:t}=await u.from("whatsapp_users").select("verified, phone_number, updated_at").eq("user_id",s).maybeSingle();return t?(console.error("Error checking verification:",t),{verified:!1,phone:null}):r?{verified:r.verified===!0,phone:r.verified?r.phone_number:null,linkedAt:r.verified?r.updated_at:null}:{verified:!1,phone:null}},K=async()=>{const s=await A(),{error:r}=await u.from("whatsapp_users").delete().eq("user_id",s);if(r)throw console.error("Error unlinking WhatsApp:",r),r;return{success:!0}},X=s=>{if(!s||s.startsWith("pending_"))return null;if(s.startsWith("+54")){const r=s.slice(3);if(r.length>=10){const t=r.slice(0,1)==="9"?r.slice(1,3):r.slice(0,2),a=r.slice(-8);return`+54 9 ${t} ${a.slice(0,4)}-${a.slice(4)}`}}return s},Z=async()=>{const s=await A(),{data:r}=await u.from("profiles").select("email, full_name").eq("id",s).single();if(!r)throw new Error("No se pudo obtener informaci√≥n del usuario");const{data:t,error:a}=await u.functions.invoke("send-access-request",{body:{userId:s,email:r.email,name:r.full_name}});if(a)throw console.error("Error requesting access:",a),a;return{success:!0}};function ee(){const{showError:s}=B(),[r,t]=o.useState("loading"),[a,n]=o.useState("not_linked"),[m,v]=o.useState({email:null,name:null}),[y,p]=o.useState(null),[h,f]=o.useState(null),[b,c]=o.useState(null),[g,j]=o.useState(null),[w,N]=o.useState(!1),[D,k]=o.useState(!1),[S,C]=o.useState(!1),[_,E]=o.useState(!1);o.useEffect(()=>{i()},[]),o.useEffect(()=>{if(a==="code_generated"){const l=setInterval(async()=>{const d=await Q();d.verified&&(n("linked"),f(d.phone),c(d.linkedAt),p(null))},3e3);return()=>clearInterval(l)}},[a]),o.useEffect(()=>{if(!g||a!=="code_generated")return;const d=setInterval(()=>{new Date>new Date(g)&&(n("not_linked"),p(null),j(null))},1e3);return()=>clearInterval(d)},[g,a]);const i=async()=>{try{const l=await H();if(v({email:l.email,name:l.name}),!l.enabled){t("restricted");return}t("enabled");const d=await Y();d.status==="linked"?(n("linked"),f(d.phone),c(d.linkedAt)):d.status==="pending_verification"&&d.verificationCode?(n("code_generated"),p(d.verificationCode),j(d.expiresAt)):n("not_linked")}catch(l){console.error("Error checking status:",l),t("restricted")}},x=async()=>{N(!0);try{const l=await J();p(l.code),j(l.expiresAt),n("code_generated")}catch(l){console.error("Error generating code:",l),s("Error al generar el c√≥digo. Por favor intent√° de nuevo.")}finally{N(!1)}},T=async()=>{N(!0);try{await K(),n("not_linked"),f(null),c(null),k(!1)}catch(l){console.error("Error unlinking WhatsApp:",l),s("Error al desvincular WhatsApp. Por favor intent√° de nuevo.")}finally{N(!1)}},O=async()=>{E(!0);try{await Z(),C(!0),t("requested")}catch(l){console.error("Error requesting access:",l),s("No se pudo enviar la solicitud. Por favor intent√° de nuevo.")}finally{E(!1)}},U=o.useCallback(()=>{if(!g)return null;const l=new Date(g).getTime()-Date.now();if(l<=0)return null;const d=Math.floor(l/6e4),G=Math.floor(l%6e4/1e3);return`${d}:${G.toString().padStart(2,"0")}`},[g]),[W,P]=o.useState(null);o.useEffect(()=>{if(a!=="code_generated"){P(null);return}const l=()=>P(U());l();const d=setInterval(l,1e3);return()=>clearInterval(d)},[a,U]);const M=()=>e.jsx("svg",{viewBox:"0 0 24 24",fill:"currentColor",className:"w-8 h-8",children:e.jsx("path",{d:"M17.472 14.382c-.297-.149-1.758-.867-2.03-.967-.273-.099-.471-.148-.67.15-.197.297-.767.966-.94 1.164-.173.199-.347.223-.644.075-.297-.15-1.255-.463-2.39-1.475-.883-.788-1.48-1.761-1.653-2.059-.173-.297-.018-.458.13-.606.134-.133.298-.347.446-.52.149-.174.198-.298.298-.497.099-.198.05-.371-.025-.52-.075-.149-.669-1.612-.916-2.207-.242-.579-.487-.5-.669-.51-.173-.008-.371-.01-.57-.01-.198 0-.52.074-.792.372-.272.297-1.04 1.016-1.04 2.479 0 1.462 1.065 2.875 1.213 3.074.149.198 2.096 3.2 5.077 4.487.709.306 1.262.489 1.694.625.712.227 1.36.195 1.871.118.571-.085 1.758-.719 2.006-1.413.248-.694.248-1.289.173-1.413-.074-.124-.272-.198-.57-.347m-5.421 7.403h-.004a9.87 9.87 0 01-5.031-1.378l-.361-.214-3.741.982.998-3.648-.235-.374a9.86 9.86 0 01-1.51-5.26c.001-5.45 4.436-9.884 9.888-9.884 2.64 0 5.122 1.03 6.988 2.898a9.825 9.825 0 012.893 6.994c-.003 5.45-4.437 9.884-9.885 9.884m8.413-18.297A11.815 11.815 0 0012.05 0C5.495 0 .16 5.335.157 11.892c0 2.096.547 4.142 1.588 5.945L.057 24l6.305-1.654a11.882 11.882 0 005.683 1.448h.005c6.554 0 11.89-5.335 11.893-11.893a11.821 11.821 0 00-3.48-8.413z"})}),z=()=>e.jsxs("div",{className:"p-4 rounded-xl mb-4",style:{backgroundColor:"var(--bg-tertiary)"},children:[e.jsx("h4",{className:"font-medium text-sm mb-3",style:{color:"var(--text-primary)"},children:"¬øQu√© pod√©s hacer con el bot?"}),e.jsxs("ul",{className:"text-sm space-y-2",style:{color:"var(--text-secondary)"},children:[e.jsxs("li",{className:"flex items-start gap-2",children:[e.jsx("span",{style:{color:"#25D366"},children:"üí∏"}),e.jsxs("span",{children:[e.jsx("strong",{children:"Registrar gastos"})," - Seleccion√° cuenta, categor√≠a y monto"]})]}),e.jsxs("li",{className:"flex items-start gap-2",children:[e.jsx("span",{style:{color:"#25D366"},children:"üí∞"}),e.jsxs("span",{children:[e.jsx("strong",{children:"Registrar ingresos"})," - R√°pido y desde el celular"]})]}),e.jsxs("li",{className:"flex items-start gap-2",children:[e.jsx("span",{style:{color:"#25D366"},children:"üîÑ"}),e.jsxs("span",{children:[e.jsx("strong",{children:"Transferencias"})," - Entre tus cuentas en pesos y d√≥lares"]})]}),e.jsxs("li",{className:"flex items-start gap-2",children:[e.jsx("span",{style:{color:"#25D366"},children:"üìä"}),e.jsxs("span",{children:[e.jsx("strong",{children:"Ver saldos"})," - Consult√° el balance de todas tus cuentas"]})]}),e.jsxs("li",{className:"flex items-start gap-2",children:[e.jsx("span",{style:{color:"#25D366"},children:"üìà"}),e.jsxs("span",{children:[e.jsx("strong",{children:"Resumen mensual"})," - Gastos por categor√≠a del mes"]})]}),e.jsxs("li",{className:"flex items-start gap-2",children:[e.jsx("span",{style:{color:"#25D366"},children:"üïê"}),e.jsxs("span",{children:[e.jsx("strong",{children:"√öltimos movimientos"})," - Los 10 m√°s recientes"]})]})]})]});return e.jsxs(e.Fragment,{children:[e.jsxs("div",{className:"rounded-2xl p-6 border transition-all",style:{backgroundColor:"var(--bg-secondary)",borderColor:a==="linked"?"rgba(37, 211, 102, 0.3)":"var(--border-color)"},children:[e.jsxs("div",{className:"flex items-center gap-4 mb-4",children:[e.jsx("div",{className:"w-14 h-14 rounded-xl flex items-center justify-center",style:{backgroundColor:a==="linked"?"rgba(37, 211, 102, 0.15)":"rgba(37, 211, 102, 0.1)",color:"#25D366"},children:e.jsx(M,{})}),e.jsxs("div",{className:"flex-1",children:[e.jsx("h3",{className:"font-semibold text-lg",style:{color:"var(--text-primary)"},children:"Bot de WhatsApp"}),e.jsx("p",{className:"text-sm",style:{color:"var(--text-secondary)"},children:a==="linked"?"Vinculado - Registr√° movimientos por mensaje":"Registr√° gastos e ingresos por mensaje"})]}),a==="linked"&&e.jsx("div",{className:"px-3 py-1 rounded-full text-sm font-medium",style:{backgroundColor:"rgba(37, 211, 102, 0.15)",color:"#25D366"},children:"Conectado"})]}),e.jsx(z,{}),r==="loading"&&e.jsx("div",{className:"flex items-center justify-center py-8",children:e.jsx("div",{className:"w-6 h-6 border-2 border-t-transparent rounded-full animate-spin",style:{borderColor:"var(--accent-primary)",borderTopColor:"transparent"}})}),r==="restricted"&&e.jsxs("div",{className:"mt-2",children:[e.jsxs("div",{className:"p-4 rounded-xl mb-4 flex items-start gap-3",style:{backgroundColor:"rgba(251, 191, 36, 0.1)"},children:[e.jsx("span",{className:"text-xl",children:"üîí"}),e.jsxs("div",{children:[e.jsx("p",{className:"font-medium text-sm",style:{color:"var(--text-primary)"},children:"Acceso restringido"}),e.jsx("p",{className:"text-sm mt-1",style:{color:"var(--text-secondary)"},children:"El bot de WhatsApp est√° en fase beta. Solicit√° acceso para probarlo."})]})]}),e.jsx("button",{onClick:O,disabled:_,className:"w-full py-3 px-4 rounded-xl font-medium transition-all flex items-center justify-center gap-2",style:{backgroundColor:"var(--accent-primary)",color:"white",opacity:_?.7:1},children:_?e.jsxs(e.Fragment,{children:[e.jsx("div",{className:"w-5 h-5 border-2 border-white border-t-transparent rounded-full animate-spin"}),e.jsx("span",{children:"Enviando solicitud..."})]}):e.jsxs(e.Fragment,{children:[e.jsx("span",{children:"Solicitar acceso"}),e.jsx("svg",{className:"w-4 h-4",fill:"none",stroke:"currentColor",viewBox:"0 0 24 24",children:e.jsx("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:2,d:"M12 19l9 2-9-18-9 18 9-2zm0 0v-8"})})]})})]}),r==="requested"&&e.jsx("div",{className:"mt-2",children:e.jsxs("div",{className:"p-4 rounded-xl flex items-start gap-3",style:{backgroundColor:"rgba(34, 197, 94, 0.1)"},children:[e.jsx("span",{className:"text-xl",children:"‚úÖ"}),e.jsxs("div",{children:[e.jsx("p",{className:"font-medium text-sm",style:{color:"var(--text-primary)"},children:"Solicitud enviada"}),e.jsx("p",{className:"text-sm mt-1",style:{color:"var(--text-secondary)"},children:"Te notificaremos cuando tu acceso est√© habilitado."})]})]})}),r==="enabled"&&a==="not_linked"&&e.jsx("div",{className:"mt-2",children:e.jsx("button",{onClick:x,disabled:w,className:"w-full py-3 px-4 rounded-xl font-medium transition-all flex items-center justify-center gap-2",style:{backgroundColor:"#25D366",color:"white",opacity:w?.7:1},children:w?e.jsxs(e.Fragment,{children:[e.jsx("div",{className:"w-5 h-5 border-2 border-white border-t-transparent rounded-full animate-spin"}),e.jsx("span",{children:"Generando c√≥digo..."})]}):e.jsx("span",{children:"Vincular WhatsApp"})})}),r==="enabled"&&a==="code_generated"&&e.jsxs("div",{className:"mt-2",children:[e.jsx("p",{className:"text-sm mb-3",style:{color:"var(--text-secondary)"},children:"Envi√° este c√≥digo al bot de WhatsApp de Cash√©:"}),e.jsx("div",{className:"flex justify-center gap-2 mb-4",children:y==null?void 0:y.split("").map((l,d)=>e.jsx("span",{className:"w-12 h-14 rounded-xl flex items-center justify-center text-2xl font-bold",style:{backgroundColor:"var(--bg-tertiary)",color:"var(--accent-primary)"},children:l},d))}),e.jsxs("div",{className:"flex items-center justify-center gap-2 text-sm mb-4",style:{color:"var(--text-secondary)"},children:[e.jsx("div",{className:"w-4 h-4 border-2 border-t-transparent rounded-full animate-spin",style:{borderColor:"#25D366",borderTopColor:"transparent"}}),e.jsx("span",{children:"Esperando verificaci√≥n..."})]}),W&&e.jsxs("p",{className:"text-xs text-center mb-4",style:{color:"var(--text-muted)"},children:["El c√≥digo expira en ",W]}),e.jsxs("a",{href:`https://wa.me/${R}?text=${encodeURIComponent(y||"")}`,target:"_blank",rel:"noopener noreferrer",className:"w-full py-3 px-4 rounded-xl font-medium transition-all flex items-center justify-center gap-2 mb-3",style:{backgroundColor:"#25D366",color:"white"},children:[e.jsx(M,{}),e.jsx("span",{children:"Abrir WhatsApp"})]}),e.jsx("button",{onClick:()=>{n("not_linked"),p(null),j(null)},className:"w-full py-2 px-4 rounded-xl text-sm transition-all",style:{backgroundColor:"var(--bg-tertiary)",color:"var(--text-secondary)"},children:"Cancelar"})]}),r==="enabled"&&a==="linked"&&e.jsxs("div",{className:"mt-2",children:[e.jsx("div",{className:"p-4 rounded-xl mb-4",style:{backgroundColor:"var(--bg-tertiary)"},children:e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsxs("div",{children:[e.jsx("p",{className:"text-sm",style:{color:"var(--text-muted)"},children:"N√∫mero vinculado"}),e.jsx("p",{className:"font-medium",style:{color:"var(--text-primary)"},children:X(h)||h})]}),b&&e.jsxs("div",{className:"text-right",children:[e.jsx("p",{className:"text-sm",style:{color:"var(--text-muted)"},children:"Vinculado"}),e.jsx("p",{className:"text-sm",style:{color:"var(--text-secondary)"},children:new Date(b).toLocaleDateString("es-AR",{day:"numeric",month:"short",year:"numeric"})})]})]})}),e.jsxs("a",{href:`https://wa.me/${R}`,target:"_blank",rel:"noopener noreferrer",className:"w-full py-3 px-4 rounded-xl font-medium transition-all flex items-center justify-center gap-2 mb-3",style:{backgroundColor:"#25D366",color:"white"},children:[e.jsx("svg",{viewBox:"0 0 24 24",fill:"currentColor",className:"w-5 h-5",children:e.jsx("path",{d:"M17.472 14.382c-.297-.149-1.758-.867-2.03-.967-.273-.099-.471-.148-.67.15-.197.297-.767.966-.94 1.164-.173.199-.347.223-.644.075-.297-.15-1.255-.463-2.39-1.475-.883-.788-1.48-1.761-1.653-2.059-.173-.297-.018-.458.13-.606.134-.133.298-.347.446-.52.149-.174.198-.298.298-.497.099-.198.05-.371-.025-.52-.075-.149-.669-1.612-.916-2.207-.242-.579-.487-.5-.669-.51-.173-.008-.371-.01-.57-.01-.198 0-.52.074-.792.372-.272.297-1.04 1.016-1.04 2.479 0 1.462 1.065 2.875 1.213 3.074.149.198 2.096 3.2 5.077 4.487.709.306 1.262.489 1.694.625.712.227 1.36.195 1.871.118.571-.085 1.758-.719 2.006-1.413.248-.694.248-1.289.173-1.413-.074-.124-.272-.198-.57-.347m-5.421 7.403h-.004a9.87 9.87 0 01-5.031-1.378l-.361-.214-3.741.982.998-3.648-.235-.374a9.86 9.86 0 01-1.51-5.26c.001-5.45 4.436-9.884 9.888-9.884 2.64 0 5.122 1.03 6.988 2.898a9.825 9.825 0 012.893 6.994c-.003 5.45-4.437 9.884-9.885 9.884m8.413-18.297A11.815 11.815 0 0012.05 0C5.495 0 .16 5.335.157 11.892c0 2.096.547 4.142 1.588 5.945L.057 24l6.305-1.654a11.882 11.882 0 005.683 1.448h.005c6.554 0 11.89-5.335 11.893-11.893a11.821 11.821 0 00-3.48-8.413z"})}),e.jsx("span",{children:"Abrir chat con el bot"})]}),e.jsx("button",{onClick:()=>k(!0),className:"w-full py-2 px-4 rounded-xl text-sm transition-all",style:{backgroundColor:"var(--bg-tertiary)",color:"var(--text-secondary)"},children:"Desvincular WhatsApp"})]})]}),e.jsx(V,{isOpen:D,onClose:()=>k(!1),onConfirm:T,title:"Desvincular WhatsApp",message:"¬øEst√°s seguro de que quer√©s desvincular tu WhatsApp? Ya no podr√°s registrar movimientos por mensaje.",confirmText:"Desvincular",variant:"warning",loading:w}),S&&e.jsxs("div",{className:"fixed inset-0 z-50 flex items-center justify-center p-4",children:[e.jsx("div",{className:"absolute inset-0 bg-black/60 backdrop-blur-sm",onClick:()=>C(!1)}),e.jsxs("div",{className:"relative w-full max-w-sm rounded-2xl p-6 text-center animate-scale-in",style:{backgroundColor:"var(--bg-secondary)"},children:[e.jsx("div",{className:"w-16 h-16 mx-auto mb-4 rounded-full flex items-center justify-center",style:{backgroundColor:"rgba(34, 197, 94, 0.15)"},children:e.jsx("svg",{className:"w-8 h-8",style:{color:"#22c55e"},fill:"none",stroke:"currentColor",viewBox:"0 0 24 24",children:e.jsx("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:2,d:"M5 13l4 4L19 7"})})}),e.jsx("h3",{className:"text-lg font-semibold mb-2",style:{color:"var(--text-primary)"},children:"Solicitud enviada"}),e.jsx("p",{className:"text-sm mb-6",style:{color:"var(--text-secondary)"},children:"Tu solicitud de acceso al bot de WhatsApp fue enviada correctamente. Te notificaremos cuando est√© habilitado."}),e.jsx("button",{onClick:()=>C(!1),className:"w-full py-3 px-4 rounded-xl font-medium transition-all",style:{backgroundColor:"var(--accent-primary)",color:"white"},children:"Entendido"})]})]})]})}const q="CasheAppBot",I=async()=>{const{data:{user:s},error:r}=await u.auth.getUser();if(r)throw console.error("Error getting user:",r),new Error("Error getting authenticated user");if(!s)throw new Error("No authenticated user");return s.id},re=async()=>{const s=await I(),{data:r,error:t}=await u.from("telegram_users").select("*").eq("user_id",s).maybeSingle();if(t)throw console.error("Error getting Telegram status:",t),t;if(!r)return{status:"not_linked",telegramId:null,telegramUsername:null,telegramFirstName:null,verificationCode:null,linkedAt:null};if(r.verified)return{status:"linked",telegramId:r.telegram_id,telegramUsername:r.telegram_username,telegramFirstName:r.telegram_first_name,verificationCode:null,linkedAt:r.updated_at};const a=r.verification_expires_at&&new Date(r.verification_expires_at)<new Date;return{status:a?"code_expired":"pending_verification",telegramId:null,telegramUsername:null,telegramFirstName:null,verificationCode:a?null:r.verification_code,expiresAt:r.verification_expires_at,linkedAt:null}},se=async()=>{const s=await I(),r=Math.floor(1e5+Math.random()*9e5).toString(),t=new Date(Date.now()+600*1e3).toISOString(),{data:a,error:n}=await u.from("telegram_users").upsert({user_id:s,telegram_id:null,verification_code:r,verification_expires_at:t,verified:!1,updated_at:new Date().toISOString()},{onConflict:"user_id",ignoreDuplicates:!1}).select().single();if(n)throw console.error("Error generating verification code:",n),n;return{code:r,expiresAt:t,expiresIn:600}},te=async()=>{const s=await I(),{data:r,error:t}=await u.from("telegram_users").select("verified, telegram_id, telegram_username, telegram_first_name, updated_at").eq("user_id",s).maybeSingle();return t?(console.error("Error checking verification:",t),{verified:!1,telegramUsername:null}):r?{verified:r.verified===!0,telegramId:r.verified?r.telegram_id:null,telegramUsername:r.verified?r.telegram_username:null,telegramFirstName:r.verified?r.telegram_first_name:null,linkedAt:r.verified?r.updated_at:null}:{verified:!1,telegramUsername:null}},ae=async()=>{const s=await I(),{error:r}=await u.from("telegram_users").delete().eq("user_id",s);if(r)throw console.error("Error unlinking Telegram:",r),r;return{success:!0}},ne=s=>s?s.startsWith("@")?s:`@${s}`:null;function ie(){const{showError:s}=B(),[r,t]=o.useState("loading"),[a,n]=o.useState(null),[m,v]=o.useState({telegramId:null,telegramUsername:null,telegramFirstName:null}),[y,p]=o.useState(null),[h,f]=o.useState(null),[b,c]=o.useState(!1),[g,j]=o.useState(!1);o.useEffect(()=>{w()},[]),o.useEffect(()=>{if(r==="code_generated"){const i=setInterval(async()=>{const x=await te();x.verified&&(t("linked"),v({telegramId:x.telegramId,telegramUsername:x.telegramUsername,telegramFirstName:x.telegramFirstName}),p(x.linkedAt),n(null))},3e3);return()=>clearInterval(i)}},[r]),o.useEffect(()=>{if(!h||r!=="code_generated")return;const x=setInterval(()=>{new Date>new Date(h)&&(t("not_linked"),n(null),f(null))},1e3);return()=>clearInterval(x)},[h,r]);const w=async()=>{try{const i=await re();i.status==="linked"?(t("linked"),v({telegramId:i.telegramId,telegramUsername:i.telegramUsername,telegramFirstName:i.telegramFirstName}),p(i.linkedAt)):i.status==="pending_verification"&&i.verificationCode?(t("code_generated"),n(i.verificationCode),f(i.expiresAt)):t("not_linked")}catch(i){console.error("Error checking status:",i),t("not_linked")}},N=async()=>{c(!0);try{const i=await se();n(i.code),f(i.expiresAt),t("code_generated")}catch(i){console.error("Error generating code:",i),s("Error al generar el c√≥digo. Por favor intent√° de nuevo.")}finally{c(!1)}},D=async()=>{c(!0);try{await ae(),t("not_linked"),v({telegramId:null,telegramUsername:null,telegramFirstName:null}),p(null),j(!1)}catch(i){console.error("Error unlinking Telegram:",i),s("Error al desvincular Telegram. Por favor intent√° de nuevo.")}finally{c(!1)}},k=o.useCallback(()=>{if(!h)return null;const i=new Date(h).getTime()-Date.now();if(i<=0)return null;const x=Math.floor(i/6e4),T=Math.floor(i%6e4/1e3);return`${x}:${T.toString().padStart(2,"0")}`},[h]),[S,C]=o.useState(null);o.useEffect(()=>{if(r!=="code_generated"){C(null);return}const i=()=>C(k());i();const x=setInterval(i,1e3);return()=>clearInterval(x)},[r,k]);const _=()=>e.jsx("svg",{viewBox:"0 0 24 24",fill:"currentColor",className:"w-8 h-8",children:e.jsx("path",{d:"M11.944 0A12 12 0 0 0 0 12a12 12 0 0 0 12 12 12 12 0 0 0 12-12A12 12 0 0 0 12 0a12 12 0 0 0-.056 0zm4.962 7.224c.1-.002.321.023.465.14a.506.506 0 0 1 .171.325c.016.093.036.306.02.472-.18 1.898-.962 6.502-1.36 8.627-.168.9-.499 1.201-.82 1.23-.696.065-1.225-.46-1.9-.902-1.056-.693-1.653-1.124-2.678-1.8-1.185-.78-.417-1.21.258-1.91.177-.184 3.247-2.977 3.307-3.23.007-.032.014-.15-.056-.212s-.174-.041-.249-.024c-.106.024-1.793 1.14-5.061 3.345-.48.33-.913.49-1.302.48-.428-.008-1.252-.241-1.865-.44-.752-.245-1.349-.374-1.297-.789.027-.216.325-.437.893-.663 3.498-1.524 5.83-2.529 6.998-3.014 3.332-1.386 4.025-1.627 4.476-1.635z"})}),E=()=>e.jsxs("div",{className:"p-4 rounded-xl mb-4",style:{backgroundColor:"var(--bg-tertiary)"},children:[e.jsx("h4",{className:"font-medium text-sm mb-3",style:{color:"var(--text-primary)"},children:"¬øQu√© pod√©s hacer con el bot?"}),e.jsxs("ul",{className:"text-sm space-y-2",style:{color:"var(--text-secondary)"},children:[e.jsxs("li",{className:"flex items-start gap-2",children:[e.jsx("span",{style:{color:"#0088cc"},children:"üí∏"}),e.jsxs("span",{children:[e.jsx("strong",{children:"Registrar gastos"})," - Seleccion√° cuenta, categor√≠a y monto"]})]}),e.jsxs("li",{className:"flex items-start gap-2",children:[e.jsx("span",{style:{color:"#0088cc"},children:"üí∞"}),e.jsxs("span",{children:[e.jsx("strong",{children:"Registrar ingresos"})," - R√°pido y desde el celular"]})]}),e.jsxs("li",{className:"flex items-start gap-2",children:[e.jsx("span",{style:{color:"#0088cc"},children:"üîÑ"}),e.jsxs("span",{children:[e.jsx("strong",{children:"Transferencias"})," - Entre tus cuentas en pesos y d√≥lares"]})]}),e.jsxs("li",{className:"flex items-start gap-2",children:[e.jsx("span",{style:{color:"#0088cc"},children:"üìä"}),e.jsxs("span",{children:[e.jsx("strong",{children:"Ver saldos"})," - Consult√° el balance de todas tus cuentas"]})]}),e.jsxs("li",{className:"flex items-start gap-2",children:[e.jsx("span",{style:{color:"#0088cc"},children:"üìà"}),e.jsxs("span",{children:[e.jsx("strong",{children:"Resumen mensual"})," - Gastos por categor√≠a del mes"]})]}),e.jsxs("li",{className:"flex items-start gap-2",children:[e.jsx("span",{style:{color:"#0088cc"},children:"üïê"}),e.jsxs("span",{children:[e.jsx("strong",{children:"√öltimos movimientos"})," - Los 10 m√°s recientes"]})]})]})]});return e.jsxs(e.Fragment,{children:[e.jsxs("div",{className:"rounded-2xl p-6 border transition-all",style:{backgroundColor:"var(--bg-secondary)",borderColor:r==="linked"?"rgba(0, 136, 204, 0.3)":"var(--border-color)"},children:[e.jsxs("div",{className:"flex items-center gap-4 mb-4",children:[e.jsx("div",{className:"w-14 h-14 rounded-xl flex items-center justify-center",style:{backgroundColor:r==="linked"?"rgba(0, 136, 204, 0.15)":"rgba(0, 136, 204, 0.1)",color:"#0088cc"},children:e.jsx(_,{})}),e.jsxs("div",{className:"flex-1",children:[e.jsx("h3",{className:"font-semibold text-lg",style:{color:"var(--text-primary)"},children:"Bot de Telegram"}),e.jsx("p",{className:"text-sm",style:{color:"var(--text-secondary)"},children:r==="linked"?"Vinculado - Registr√° movimientos por mensaje":"Registr√° gastos e ingresos por mensaje"})]}),r==="linked"&&e.jsx("div",{className:"px-3 py-1 rounded-full text-sm font-medium",style:{backgroundColor:"rgba(0, 136, 204, 0.15)",color:"#0088cc"},children:"Conectado"})]}),e.jsx(E,{}),r==="loading"&&e.jsx("div",{className:"flex items-center justify-center py-8",children:e.jsx("div",{className:"w-6 h-6 border-2 border-t-transparent rounded-full animate-spin",style:{borderColor:"var(--accent-primary)",borderTopColor:"transparent"}})}),r==="not_linked"&&e.jsx("div",{className:"mt-2",children:e.jsx("button",{onClick:N,disabled:b,className:"w-full py-3 px-4 rounded-xl font-medium transition-all flex items-center justify-center gap-2",style:{backgroundColor:"#0088cc",color:"white",opacity:b?.7:1},children:b?e.jsxs(e.Fragment,{children:[e.jsx("div",{className:"w-5 h-5 border-2 border-white border-t-transparent rounded-full animate-spin"}),e.jsx("span",{children:"Generando c√≥digo..."})]}):e.jsx("span",{children:"Vincular Telegram"})})}),r==="code_generated"&&e.jsxs("div",{className:"mt-2",children:[e.jsx("p",{className:"text-sm mb-3 text-center",style:{color:"var(--text-secondary)"},children:"Copi√° el comando y pegalo en el chat del bot"}),e.jsxs("div",{className:"flex items-center justify-between p-4 rounded-xl mb-4",style:{backgroundColor:"var(--bg-tertiary)"},children:[e.jsxs("code",{className:"text-lg font-mono font-semibold",style:{color:"#0088cc"},children:["/start ",a]}),e.jsx("button",{onClick:()=>{navigator.clipboard.writeText(`/start ${a}`);const i=document.getElementById("copy-btn-telegram");i&&(i.textContent="¬°Copiado!",setTimeout(()=>{i.textContent="Copiar"},2e3))},id:"copy-btn-telegram",className:"px-3 py-1.5 rounded-lg text-sm font-medium transition-all",style:{backgroundColor:"#0088cc",color:"white"},children:"Copiar"})]}),e.jsxs("a",{href:`https://t.me/${q}`,target:"_blank",rel:"noopener noreferrer",className:"w-full py-3 px-4 rounded-xl font-medium transition-all flex items-center justify-center gap-2 mb-4",style:{backgroundColor:"#0088cc",color:"white"},children:[e.jsx(_,{}),e.jsx("span",{children:"Abrir chat en Telegram"})]}),e.jsxs("div",{className:"flex items-center justify-center gap-2 text-sm mb-3",style:{color:"var(--text-secondary)"},children:[e.jsx("div",{className:"w-4 h-4 border-2 border-t-transparent rounded-full animate-spin",style:{borderColor:"#0088cc",borderTopColor:"transparent"}}),e.jsx("span",{children:"Esperando vinculaci√≥n..."})]}),S&&e.jsxs("p",{className:"text-xs text-center mb-4",style:{color:"var(--text-muted)"},children:["El c√≥digo expira en ",S]}),e.jsx("button",{onClick:()=>{t("not_linked"),n(null),f(null)},className:"w-full py-2 px-4 rounded-xl text-sm transition-all",style:{backgroundColor:"var(--bg-tertiary)",color:"var(--text-secondary)"},children:"Cancelar"})]}),r==="linked"&&e.jsxs("div",{className:"mt-2",children:[e.jsx("div",{className:"p-4 rounded-xl mb-4",style:{backgroundColor:"var(--bg-tertiary)"},children:e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsxs("div",{children:[e.jsx("p",{className:"text-sm",style:{color:"var(--text-muted)"},children:"Cuenta vinculada"}),e.jsxs("p",{className:"font-medium",style:{color:"var(--text-primary)"},children:[m.telegramFirstName||"Usuario",m.telegramUsername&&e.jsxs("span",{style:{color:"var(--text-secondary)"},children:[" ","(",ne(m.telegramUsername),")"]})]})]}),y&&e.jsxs("div",{className:"text-right",children:[e.jsx("p",{className:"text-sm",style:{color:"var(--text-muted)"},children:"Vinculado"}),e.jsx("p",{className:"text-sm",style:{color:"var(--text-secondary)"},children:new Date(y).toLocaleDateString("es-AR",{day:"numeric",month:"short",year:"numeric"})})]})]})}),e.jsxs("a",{href:`https://t.me/${q}`,target:"_blank",rel:"noopener noreferrer",className:"w-full py-3 px-4 rounded-xl font-medium transition-all flex items-center justify-center gap-2 mb-3",style:{backgroundColor:"#0088cc",color:"white"},children:[e.jsx("svg",{viewBox:"0 0 24 24",fill:"currentColor",className:"w-5 h-5",children:e.jsx("path",{d:"M11.944 0A12 12 0 0 0 0 12a12 12 0 0 0 12 12 12 12 0 0 0 12-12A12 12 0 0 0 12 0a12 12 0 0 0-.056 0zm4.962 7.224c.1-.002.321.023.465.14a.506.506 0 0 1 .171.325c.016.093.036.306.02.472-.18 1.898-.962 6.502-1.36 8.627-.168.9-.499 1.201-.82 1.23-.696.065-1.225-.46-1.9-.902-1.056-.693-1.653-1.124-2.678-1.8-1.185-.78-.417-1.21.258-1.91.177-.184 3.247-2.977 3.307-3.23.007-.032.014-.15-.056-.212s-.174-.041-.249-.024c-.106.024-1.793 1.14-5.061 3.345-.48.33-.913.49-1.302.48-.428-.008-1.252-.241-1.865-.44-.752-.245-1.349-.374-1.297-.789.027-.216.325-.437.893-.663 3.498-1.524 5.83-2.529 6.998-3.014 3.332-1.386 4.025-1.627 4.476-1.635z"})}),e.jsx("span",{children:"Abrir chat con el bot"})]}),e.jsx("button",{onClick:()=>j(!0),className:"w-full py-2 px-4 rounded-xl text-sm transition-all",style:{backgroundColor:"var(--bg-tertiary)",color:"var(--text-secondary)"},children:"Desvincular Telegram"})]})]}),e.jsx(V,{isOpen:g,onClose:()=>j(!1),onConfirm:D,title:"Desvincular Telegram",message:"¬øEst√°s seguro de que quer√©s desvincular tu Telegram? Ya no podr√°s registrar movimientos por mensaje.",confirmText:"Desvincular",variant:"warning",loading:b})]})}const L=()=>"serviceWorker"in navigator&&"PushManager"in window&&"Notification"in window,$=()=>"Notification"in window?Notification.permission:"unsupported",oe=async()=>{if(!("Notification"in window))throw new Error("Notifications not supported");return await Notification.requestPermission()},le=async s=>{if(!L())throw new Error("Push notifications not supported");if(await oe()!=="granted")throw new Error("Notification permission denied");const t=await navigator.serviceWorker.ready;let a=await t.pushManager.getSubscription();if(!a){const n=xe(s);a=await t.pushManager.subscribe({userVisibleOnly:!0,applicationServerKey:n})}return await de(a),a},ce=async()=>{if(!L())return;const r=await(await navigator.serviceWorker.ready).pushManager.getSubscription();r&&(await ue(r.endpoint),await r.unsubscribe())},de=async s=>{const{data:{user:r}}=await u.auth.getUser();if(!r)throw new Error("Not authenticated");const t=s.toJSON(),{error:a}=await u.from("push_subscriptions").upsert({user_id:r.id,endpoint:t.endpoint,p256dh:t.keys.p256dh,auth:t.keys.auth},{onConflict:"user_id,endpoint"});if(a)throw a},ue=async s=>{const{data:{user:r}}=await u.auth.getUser();r&&await u.from("push_subscriptions").delete().eq("user_id",r.id).eq("endpoint",s)},me=async()=>{if(!L())return{supported:!1,subscribed:!1};const s=$();if(s==="denied")return{supported:!0,subscribed:!1,permission:"denied"};try{return{supported:!0,subscribed:!!await(await Promise.race([navigator.serviceWorker.ready,new Promise((a,n)=>setTimeout(()=>n(new Error("SW timeout")),5e3))])).pushManager.getSubscription(),permission:s}}catch(r){return console.warn("Service worker not ready:",r),{supported:!1,subscribed:!1}}};function xe(s){const r="=".repeat((4-s.length%4)%4),t=(s+r).replace(/-/g,"+").replace(/_/g,"/"),a=window.atob(t),n=new Uint8Array(a.length);for(let m=0;m<a.length;++m)n[m]=a.charCodeAt(m);return n}const F=async(s,r={})=>{if($()!=="granted")throw new Error("Notification permission not granted");await(await navigator.serviceWorker.ready).showNotification(s,{icon:"/icons/icon-192.png",badge:"/icons/icon-96.png",...r})},pe="BGAtLxt4YDMsBi4kHWTDoGusF-x1-qGY3YF6TqYzr_JOMbcVUJ2sh9cjOMHty3v6_B5F5QabzpMmFqPDjSGQRCU";function he(){const[s,r]=o.useState({supported:!1,subscribed:!1,permission:"default",loading:!0}),[t,a]=o.useState(null),[n,m]=o.useState(!1);o.useEffect(()=>{v()},[]);const v=async()=>{try{const c=await me();r({...c,loading:!1})}catch(c){console.error("Error checking push status:",c),r(g=>({...g,loading:!1}))}},y=async()=>{m(!0),a(null);try{await le(pe),await v(),await F("Notificaciones activadas",{body:"Recibir√°s alertas de transacciones programadas",tag:"subscription-success"})}catch(c){console.error("Error subscribing:",c),a(c.message||"No se pudieron activar las notificaciones")}finally{m(!1)}},p=async()=>{m(!0),a(null);try{await ce(),await v()}catch(c){console.error("Error unsubscribing:",c),a(c.message||"No se pudieron desactivar las notificaciones")}finally{m(!1)}},h=async()=>{try{await F("Notificaci√≥n de prueba",{body:"Las notificaciones funcionan correctamente",tag:"test-notification"})}catch{a("No se pudo enviar la notificaci√≥n de prueba")}},f=/iPad|iPhone|iPod/.test(navigator.userAgent),b=window.matchMedia("(display-mode: standalone)").matches||window.navigator.standalone===!0;return!s.supported&&!s.loading?e.jsx("div",{className:"rounded-2xl p-6",style:{backgroundColor:"var(--bg-secondary)"},children:e.jsxs("div",{className:"flex items-start gap-4",children:[e.jsx("div",{className:"w-14 h-14 rounded-xl flex items-center justify-center flex-shrink-0",style:{backgroundColor:"var(--bg-tertiary)"},children:e.jsx("svg",{className:"w-8 h-8",fill:"none",viewBox:"0 0 24 24",stroke:"currentColor",style:{color:"var(--text-muted)"},children:e.jsx("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:1.5,d:"M15 17h5l-1.405-1.405A2.032 2.032 0 0118 14.158V11a6.002 6.002 0 00-4-5.659V5a2 2 0 10-4 0v.341C7.67 6.165 6 8.388 6 11v3.159c0 .538-.214 1.055-.595 1.436L4 17h5m6 0v1a3 3 0 11-6 0v-1m6 0H9"})})}),e.jsxs("div",{className:"flex-1",children:[e.jsx("h3",{className:"font-semibold",style:{color:"var(--text-primary)"},children:"Notificaciones Push"}),e.jsx("p",{className:"text-sm mt-1",style:{color:"var(--text-muted)"},children:f&&!b?"Para activar notificaciones en iOS, instal√° la app: Compartir ‚Üí Agregar a pantalla de inicio":"Tu navegador no soporta notificaciones push"})]})]})}):s.permission==="denied"?e.jsx("div",{className:"rounded-2xl p-6",style:{backgroundColor:"var(--bg-secondary)"},children:e.jsxs("div",{className:"flex items-start gap-4",children:[e.jsx("div",{className:"w-14 h-14 rounded-xl flex items-center justify-center flex-shrink-0",style:{backgroundColor:"var(--accent-red-dim)"},children:e.jsx("svg",{className:"w-8 h-8",fill:"none",viewBox:"0 0 24 24",stroke:"currentColor",style:{color:"var(--accent-red)"},children:e.jsx("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:1.5,d:"M15 17h5l-1.405-1.405A2.032 2.032 0 0118 14.158V11a6.002 6.002 0 00-4-5.659V5a2 2 0 10-4 0v.341C7.67 6.165 6 8.388 6 11v3.159c0 .538-.214 1.055-.595 1.436L4 17h5m6 0v1a3 3 0 11-6 0v-1m6 0H9"})})}),e.jsxs("div",{className:"flex-1",children:[e.jsx("h3",{className:"font-semibold",style:{color:"var(--text-primary)"},children:"Notificaciones Push"}),e.jsx("p",{className:"text-sm mt-1",style:{color:"var(--text-secondary)"},children:"Las notificaciones est√°n bloqueadas. Para activarlas, debes cambiar los permisos en la configuraci√≥n de tu navegador."})]})]})}):e.jsx("div",{className:"rounded-2xl p-6",style:{backgroundColor:"var(--bg-secondary)"},children:e.jsxs("div",{className:"flex items-start gap-4",children:[e.jsx("div",{className:"w-14 h-14 rounded-xl flex items-center justify-center flex-shrink-0",style:{backgroundColor:s.subscribed?"var(--accent-green-dim)":"var(--accent-primary-dim)"},children:e.jsx("svg",{className:"w-8 h-8",fill:"none",viewBox:"0 0 24 24",stroke:"currentColor",style:{color:s.subscribed?"var(--accent-green)":"var(--accent-primary)"},children:e.jsx("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:1.5,d:"M15 17h5l-1.405-1.405A2.032 2.032 0 0118 14.158V11a6.002 6.002 0 00-4-5.659V5a2 2 0 10-4 0v.341C7.67 6.165 6 8.388 6 11v3.159c0 .538-.214 1.055-.595 1.436L4 17h5m6 0v1a3 3 0 11-6 0v-1m6 0H9"})})}),e.jsxs("div",{className:"flex-1",children:[e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsx("h3",{className:"font-semibold",style:{color:"var(--text-primary)"},children:"Notificaciones Push"}),s.subscribed&&e.jsx("span",{className:"px-2 py-1 rounded-lg text-xs font-medium",style:{backgroundColor:"var(--accent-green-dim)",color:"var(--accent-green)"},children:"Activadas"})]}),e.jsx("p",{className:"text-sm mt-1",style:{color:"var(--text-secondary)"},children:s.subscribed?"Recibir√°s notificaciones cuando tengas transacciones programadas pendientes de aprobaci√≥n.":"Activa las notificaciones para recibir alertas de transacciones programadas."}),t&&e.jsx("p",{className:"text-sm mt-2",style:{color:"var(--accent-red)"},children:t}),e.jsx("div",{className:"flex gap-2 mt-4",children:s.subscribed?e.jsxs(e.Fragment,{children:[e.jsx("button",{onClick:h,className:"px-4 py-2 rounded-xl text-sm font-medium transition-colors",style:{backgroundColor:"var(--bg-tertiary)",color:"var(--text-secondary)"},children:"Probar"}),e.jsx("button",{onClick:p,disabled:n,className:"px-4 py-2 rounded-xl text-sm font-medium transition-colors disabled:opacity-50",style:{backgroundColor:"var(--accent-red-dim)",color:"var(--accent-red)"},children:n?"Desactivando...":"Desactivar"})]}):e.jsx("button",{onClick:y,disabled:n||s.loading,className:"px-4 py-2 rounded-xl text-sm font-medium transition-colors disabled:opacity-50",style:{backgroundColor:"var(--accent-primary)",color:"white"},children:n?"Activando...":"Activar notificaciones"})}),!s.subscribed&&e.jsx("p",{className:"text-xs mt-3",style:{color:"var(--text-muted)"},children:"Se te pedir√° permiso para enviar notificaciones. Puedes desactivarlas en cualquier momento."})]})]})})}function ge(){return e.jsxs("div",{className:"space-y-6",children:[e.jsxs("div",{children:[e.jsx("h2",{className:"text-base font-medium",style:{color:"var(--text-primary)"},children:"Integraciones"}),e.jsx("p",{className:"text-sm mt-1",style:{color:"var(--text-secondary)"},children:"Conect√° servicios externos para gestionar tus finanzas"})]}),e.jsxs("div",{className:"space-y-4",children:[e.jsx(he,{}),e.jsx(ie,{}),e.jsx(ee,{}),e.jsx("div",{className:"rounded-2xl p-6 border border-dashed",style:{backgroundColor:"var(--bg-secondary)",borderColor:"var(--border-color)",opacity:.6},children:e.jsxs("div",{className:"flex items-center gap-4",children:[e.jsx("div",{className:"w-14 h-14 rounded-xl flex items-center justify-center",style:{backgroundColor:"var(--bg-tertiary)"},children:e.jsx("svg",{className:"w-8 h-8",fill:"none",viewBox:"0 0 24 24",stroke:"currentColor",style:{color:"var(--text-muted)"},children:e.jsx("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:1.5,d:"M12 6v6m0 0v6m0-6h6m-6 0H6"})})}),e.jsxs("div",{children:[e.jsx("h3",{className:"font-semibold",style:{color:"var(--text-muted)"},children:"M√°s integraciones pr√≥ximamente"}),e.jsx("p",{className:"text-sm",style:{color:"var(--text-muted)"},children:"Importaci√≥n de extractos bancarios y m√°s"})]})]})})]})]})}export{ge as default};
