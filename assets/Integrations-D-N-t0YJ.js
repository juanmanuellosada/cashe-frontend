import{an as d,g as S,r as a,j as e,G as D}from"./index-CKWgcbuo.js";const x=async()=>{const{data:{user:n},error:r}=await d.auth.getUser();if(r)throw console.error("Error getting user:",r),new Error("Error getting authenticated user");if(!n)throw new Error("No authenticated user");return n.id},W=async()=>{const n=await x(),{data:r,error:s}=await d.from("whatsapp_users").select("*").eq("user_id",n).maybeSingle();if(s)throw console.error("Error getting WhatsApp status:",s),s;if(!r)return{status:"not_linked",phone:null,verificationCode:null,linkedAt:null};if(r.verified)return{status:"linked",phone:r.phone_number,verificationCode:null,linkedAt:r.updated_at};const i=r.verification_expires_at&&new Date(r.verification_expires_at)<new Date;return{status:i?"code_expired":"pending_verification",phone:null,verificationCode:i?null:r.verification_code,expiresAt:r.verification_expires_at,linkedAt:null}},I=async()=>{const n=await x(),r=Math.floor(1e5+Math.random()*9e5).toString(),s=new Date(Date.now()+600*1e3).toISOString(),{data:i,error:l}=await d.from("whatsapp_users").upsert({user_id:n,phone_number:`pending_${n}`,verification_code:r,verification_expires_at:s,verified:!1,updated_at:new Date().toISOString()},{onConflict:"user_id",ignoreDuplicates:!1}).select().single();if(l)throw console.error("Error generating verification code:",l),l;return{code:r,expiresAt:s,expiresIn:600}},L=async()=>{const n=await x(),{data:r,error:s}=await d.from("whatsapp_users").select("verified, phone_number, updated_at").eq("user_id",n).maybeSingle();return s?(console.error("Error checking verification:",s),{verified:!1,phone:null}):r?{verified:r.verified===!0,phone:r.verified?r.phone_number:null,linkedAt:r.verified?r.updated_at:null}:{verified:!1,phone:null}},M=async()=>{const n=await x(),{error:r}=await d.from("whatsapp_users").delete().eq("user_id",n);if(r)throw console.error("Error unlinking WhatsApp:",r),r;return{success:!0}},P=n=>{if(!n||n.startsWith("pending_"))return null;if(n.startsWith("+54")){const r=n.slice(3);if(r.length>=10){const s=r.slice(0,1)==="9"?r.slice(1,3):r.slice(0,2),i=r.slice(-8);return`+54 9 ${s} ${i.slice(0,4)}-${i.slice(4)}`}}return n};function R(){const{showError:n}=S(),[r,s]=a.useState("loading"),[i,l]=a.useState(null),[g,h]=a.useState(null),[y,f]=a.useState(null),[c,u]=a.useState(null),[m,p]=a.useState(!1),[w,v]=a.useState(!1);a.useEffect(()=>{N()},[]),a.useEffect(()=>{if(r==="code_generated"||r==="pending_verification"){const t=setInterval(async()=>{const o=await L();o.verified&&(s("linked"),h(o.phone),f(o.linkedAt),l(null))},3e3);return()=>clearInterval(t)}},[r]),a.useEffect(()=>{if(!c||r!=="code_generated")return;const o=setInterval(()=>{new Date>new Date(c)&&(s("not_linked"),l(null),u(null))},1e3);return()=>clearInterval(o)},[c,r]);const N=async()=>{try{const t=await W();t.status==="linked"?(s("linked"),h(t.phone),f(t.linkedAt)):t.status==="pending_verification"&&t.verificationCode?(s("code_generated"),l(t.verificationCode),u(t.expiresAt)):s("not_linked")}catch(t){console.error("Error checking WhatsApp status:",t),s("not_linked")}},_=async()=>{p(!0);try{const t=await I();l(t.code),u(t.expiresAt),s("code_generated")}catch(t){console.error("Error generating code:",t),n("Error al generar el código. Por favor intentá de nuevo.")}finally{p(!1)}},C=async()=>{p(!0);try{await M(),s("not_linked"),h(null),f(null),v(!1)}catch(t){console.error("Error unlinking WhatsApp:",t),n("Error al desvincular WhatsApp. Por favor intentá de nuevo.")}finally{p(!1)}},j=a.useCallback(()=>{if(!c)return null;const t=new Date(c).getTime()-Date.now();if(t<=0)return null;const o=Math.floor(t/6e4),E=Math.floor(t%6e4/1e3);return`${o}:${E.toString().padStart(2,"0")}`},[c]),[b,k]=a.useState(null);a.useEffect(()=>{if(r!=="code_generated"){k(null);return}const t=()=>k(j());t();const o=setInterval(t,1e3);return()=>clearInterval(o)},[r,j]);const A=()=>e.jsx("svg",{viewBox:"0 0 24 24",fill:"currentColor",className:"w-8 h-8",children:e.jsx("path",{d:"M17.472 14.382c-.297-.149-1.758-.867-2.03-.967-.273-.099-.471-.148-.67.15-.197.297-.767.966-.94 1.164-.173.199-.347.223-.644.075-.297-.15-1.255-.463-2.39-1.475-.883-.788-1.48-1.761-1.653-2.059-.173-.297-.018-.458.13-.606.134-.133.298-.347.446-.52.149-.174.198-.298.298-.497.099-.198.05-.371-.025-.52-.075-.149-.669-1.612-.916-2.207-.242-.579-.487-.5-.669-.51-.173-.008-.371-.01-.57-.01-.198 0-.52.074-.792.372-.272.297-1.04 1.016-1.04 2.479 0 1.462 1.065 2.875 1.213 3.074.149.198 2.096 3.2 5.077 4.487.709.306 1.262.489 1.694.625.712.227 1.36.195 1.871.118.571-.085 1.758-.719 2.006-1.413.248-.694.248-1.289.173-1.413-.074-.124-.272-.198-.57-.347m-5.421 7.403h-.004a9.87 9.87 0 01-5.031-1.378l-.361-.214-3.741.982.998-3.648-.235-.374a9.86 9.86 0 01-1.51-5.26c.001-5.45 4.436-9.884 9.888-9.884 2.64 0 5.122 1.03 6.988 2.898a9.825 9.825 0 012.893 6.994c-.003 5.45-4.437 9.884-9.885 9.884m8.413-18.297A11.815 11.815 0 0012.05 0C5.495 0 .16 5.335.157 11.892c0 2.096.547 4.142 1.588 5.945L.057 24l6.305-1.654a11.882 11.882 0 005.683 1.448h.005c6.554 0 11.89-5.335 11.893-11.893a11.821 11.821 0 00-3.48-8.413z"})});return e.jsxs(e.Fragment,{children:[e.jsxs("div",{className:"rounded-2xl p-6 border transition-all",style:{backgroundColor:"var(--bg-secondary)",borderColor:r==="linked"?"rgba(37, 211, 102, 0.3)":"var(--border-color)"},children:[e.jsxs("div",{className:"flex items-center gap-4 mb-4",children:[e.jsx("div",{className:"w-14 h-14 rounded-xl flex items-center justify-center",style:{backgroundColor:r==="linked"?"rgba(37, 211, 102, 0.15)":"rgba(37, 211, 102, 0.1)",color:"#25D366"},children:e.jsx(A,{})}),e.jsxs("div",{className:"flex-1",children:[e.jsx("h3",{className:"font-semibold text-lg",style:{color:"var(--text-primary)"},children:"WhatsApp"}),e.jsx("p",{className:"text-sm",style:{color:"var(--text-secondary)"},children:r==="linked"?"Vinculado - Registrá movimientos por mensaje":"Registrá gastos e ingresos por mensaje"})]}),r==="linked"&&e.jsx("div",{className:"px-3 py-1 rounded-full text-sm font-medium",style:{backgroundColor:"rgba(37, 211, 102, 0.15)",color:"#25D366"},children:"Conectado"})]}),r==="loading"&&e.jsx("div",{className:"flex items-center justify-center py-8",children:e.jsx("div",{className:"w-6 h-6 border-2 border-t-transparent rounded-full animate-spin",style:{borderColor:"var(--accent-primary)",borderTopColor:"transparent"}})}),r==="not_linked"&&e.jsxs("div",{className:"mt-4",children:[e.jsx("p",{className:"text-sm mb-4",style:{color:"var(--text-secondary)"},children:"Vinculá tu WhatsApp para registrar gastos, ingresos y transferencias enviando mensajes de texto. Por ejemplo:"}),e.jsxs("ul",{className:"text-sm mb-6 space-y-1",style:{color:"var(--text-muted)"},children:[e.jsx("li",{children:'"Gasté 5000 en el super con la visa"'}),e.jsx("li",{children:'"Cobré 150000 de sueldo en Galicia"'}),e.jsx("li",{children:'"¿Cuánto gasté este mes?"'})]}),e.jsx("button",{onClick:_,disabled:m,className:"w-full py-3 px-4 rounded-xl font-medium transition-all flex items-center justify-center gap-2",style:{backgroundColor:"#25D366",color:"white",opacity:m?.7:1},children:m?e.jsxs(e.Fragment,{children:[e.jsx("div",{className:"w-5 h-5 border-2 border-white border-t-transparent rounded-full animate-spin"}),e.jsx("span",{children:"Generando código..."})]}):e.jsx("span",{children:"Vincular WhatsApp"})})]}),r==="code_generated"&&e.jsxs("div",{className:"mt-4",children:[e.jsx("p",{className:"text-sm mb-3",style:{color:"var(--text-secondary)"},children:"Enviá este código al número de WhatsApp de Cashé:"}),e.jsx("div",{className:"flex justify-center gap-2 mb-4",children:i==null?void 0:i.split("").map((t,o)=>e.jsx("span",{className:"w-12 h-14 rounded-xl flex items-center justify-center text-2xl font-bold",style:{backgroundColor:"var(--bg-tertiary)",color:"var(--accent-primary)"},children:t},o))}),e.jsxs("div",{className:"flex items-center justify-center gap-2 text-sm mb-4",style:{color:"var(--text-secondary)"},children:[e.jsx("div",{className:"w-4 h-4 border-2 border-t-transparent rounded-full animate-spin",style:{borderColor:"#25D366",borderTopColor:"transparent"}}),e.jsx("span",{children:"Esperando verificación..."})]}),b&&e.jsxs("p",{className:"text-xs text-center",style:{color:"var(--text-muted)"},children:["El código expira en ",b]}),e.jsx("button",{onClick:()=>{s("not_linked"),l(null),u(null)},className:"w-full mt-4 py-2 px-4 rounded-xl text-sm transition-all",style:{backgroundColor:"var(--bg-tertiary)",color:"var(--text-secondary)"},children:"Cancelar"})]}),r==="linked"&&e.jsxs("div",{className:"mt-4",children:[e.jsx("div",{className:"p-4 rounded-xl mb-4",style:{backgroundColor:"var(--bg-tertiary)"},children:e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsxs("div",{children:[e.jsx("p",{className:"text-sm",style:{color:"var(--text-muted)"},children:"Número vinculado"}),e.jsx("p",{className:"font-medium",style:{color:"var(--text-primary)"},children:P(g)||g})]}),y&&e.jsxs("div",{className:"text-right",children:[e.jsx("p",{className:"text-sm",style:{color:"var(--text-muted)"},children:"Vinculado"}),e.jsx("p",{className:"text-sm",style:{color:"var(--text-secondary)"},children:new Date(y).toLocaleDateString("es-AR",{day:"numeric",month:"short",year:"numeric"})})]})]})}),e.jsx("p",{className:"text-sm mb-4",style:{color:"var(--text-secondary)"},children:'Ya podés enviar mensajes para registrar movimientos. Por ejemplo: "Gasté 3000 en taxi"'}),e.jsx("button",{onClick:()=>v(!0),className:"w-full py-2 px-4 rounded-xl text-sm transition-all",style:{backgroundColor:"var(--bg-tertiary)",color:"var(--text-secondary)"},children:"Desvincular WhatsApp"})]})]}),e.jsx(D,{isOpen:w,onClose:()=>v(!1),onConfirm:C,title:"Desvincular WhatsApp",message:"¿Estás seguro de que querés desvincular tu WhatsApp? Ya no podrás registrar movimientos por mensaje.",confirmText:"Desvincular",variant:"warning",loading:m})]})}function V(){return e.jsx("div",{className:"min-h-screen p-4 sm:p-6 lg:p-8",style:{backgroundColor:"var(--bg-primary)"},children:e.jsxs("div",{className:"max-w-2xl mx-auto",children:[e.jsxs("div",{className:"mb-8",children:[e.jsx("h1",{className:"text-2xl font-bold",style:{color:"var(--text-primary)"},children:"Integraciones"}),e.jsx("p",{className:"mt-1 text-sm",style:{color:"var(--text-secondary)"},children:"Conectá servicios externos para gestionar tus finanzas de forma más cómoda"})]}),e.jsxs("div",{className:"space-y-6",children:[e.jsx(R,{}),e.jsx("div",{className:"rounded-2xl p-6 border border-dashed",style:{backgroundColor:"var(--bg-secondary)",borderColor:"var(--border-color)",opacity:.6},children:e.jsxs("div",{className:"flex items-center gap-4",children:[e.jsx("div",{className:"w-14 h-14 rounded-xl flex items-center justify-center",style:{backgroundColor:"var(--bg-tertiary)"},children:e.jsx("svg",{className:"w-8 h-8",fill:"none",viewBox:"0 0 24 24",stroke:"currentColor",style:{color:"var(--text-muted)"},children:e.jsx("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:1.5,d:"M12 6v6m0 0v6m0-6h6m-6 0H6"})})}),e.jsxs("div",{children:[e.jsx("h3",{className:"font-semibold",style:{color:"var(--text-muted)"},children:"Más integraciones próximamente"}),e.jsx("p",{className:"text-sm",style:{color:"var(--text-muted)"},children:"Telegram, importación de extractos bancarios y más"})]})]})})]})]})})}export{V as default};
