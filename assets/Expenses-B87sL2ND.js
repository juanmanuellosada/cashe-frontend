import{o as H,r as o,a0 as I,y as _,z as P,x as T,j as d,E as U,a1 as b,a2 as j,B as r,a3 as B,A as O,D as n,C as X,a4 as R}from"./index-WRYg3urL.js";import{M as q}from"./MovementsList-CTuNEgx6.js";import{P as z}from"./PullToRefresh-fVk0wcjM.js";import"./DateRangePicker-D80y4pjy.js";import"./SortDropdown-CbvfM2nm.js";function V(){const{showError:p}=H(),[N,c]=o.useState([]),[g,A]=o.useState([]),[S,h]=o.useState({ingresos:[],gastos:[]}),[f,C]=o.useState(!0),[x,u]=o.useState(null),[M,m]=o.useState(!1),[y,w]=o.useState(!1),a=o.useCallback(async(e=!1,t=!0)=>{try{t&&C(!0);const[s,l,i]=await Promise.all([I(e),_(),P()]);c(s.expenses||[]),A(l.accounts||[]),h(i.categorias||{ingresos:[],gastos:[]})}catch(s){console.error("Error fetching data:",s)}finally{t&&C(!1)}},[]);o.useEffect(()=>{a()},[a]),T(n.EXPENSES_CHANGED,()=>a(!0,!1));const v=async e=>{try{m(!0),await X(e),e.applyToSubsequent&&e.idCompra&&await R(e),u(null),r(n.EXPENSES_CHANGED),r(n.ACCOUNTS_CHANGED),await a(!0,!1)}catch(t){console.error("Error updating:",t),p("No se pudo guardar el gasto",t.message)}finally{m(!1)}},D=async e=>{u(null),c(t=>t.filter(s=>s.rowIndex!==e.rowIndex));try{await O(e),r(n.EXPENSES_CHANGED),r(n.ACCOUNTS_CHANGED)}catch(t){console.error("Error deleting:",t),p("No se pudo eliminar el gasto",t.message),a()}},G=async e=>{const t=new Set(e.map(s=>s.rowIndex));c(s=>s.filter(l=>!t.has(l.rowIndex))),await B(e),r(n.EXPENSES_CHANGED),r(n.ACCOUNTS_CHANGED),await a()},k=async(e,t,s)=>{const l=new Set(e.map(i=>i.rowIndex));c(i=>i.map(E=>l.has(E.rowIndex)?{...E,[t]:s}:E)),await j(e,t,s),r(n.EXPENSES_CHANGED),r(n.ACCOUNTS_CHANGED),await a()};return d.jsxs(z,{onRefresh:a,disabled:f,children:[d.jsx(q,{title:"Gastos",movements:N,accounts:g,categories:S.gastos||[],loading:f,onMovementClick:u,onMovementDelete:D,onBulkDelete:G,onBulkUpdate:k,onAddClick:()=>w(!0),type:"gasto"}),x&&d.jsx(U,{movement:x,accounts:g,categories:S,onSave:v,onDelete:D,onClose:()=>u(null),onConvertedToRecurring:()=>a(!0,!1),loading:M}),d.jsx(b,{isOpen:y,onClose:()=>{w(!1),a()},defaultType:"expense"})]})}export{V as default};
