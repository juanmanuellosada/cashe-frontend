import{g as k,r as o,W as H,o as I,p as P,n as T,j as d,E as U,X as b,Y as j,v as r,Z as X,q as O,D as n,w as B,_ as R}from"./index-k7BheE9E.js";import{M as q}from"./MovementsList-D6ykBfNP.js";import{P as L}from"./PullToRefresh-UYnO5keD.js";import"./DateRangePicker-B1Gin6QR.js";import"./subMonths-iIdC1yWY.js";import"./SortDropdown-CK6cdXia.js";function K(){const{showError:p}=k(),[N,c]=o.useState([]),[g,A]=o.useState([]),[S,h]=o.useState({ingresos:[],gastos:[]}),[f,C]=o.useState(!0),[m,u]=o.useState(null),[M,w]=o.useState(!1),[v,x]=o.useState(!1),a=o.useCallback(async(e=!1,t=!0)=>{try{t&&C(!0);const[s,l,i]=await Promise.all([H(e),I(),P()]);c(s.expenses||[]),A(l.accounts||[]),h(i.categorias||{ingresos:[],gastos:[]})}catch(s){console.error("Error fetching data:",s)}finally{t&&C(!1)}},[]);o.useEffect(()=>{a()},[a]),T(n.EXPENSES_CHANGED,()=>a(!0,!1));const y=async e=>{try{w(!0),await B(e),e.applyToSubsequent&&e.idCompra&&await R(e),u(null),r(n.EXPENSES_CHANGED),r(n.ACCOUNTS_CHANGED),await a(!0,!1)}catch(t){console.error("Error updating:",t),p("No se pudo guardar el gasto",t.message)}finally{w(!1)}},D=async e=>{u(null),c(t=>t.filter(s=>s.rowIndex!==e.rowIndex));try{await O(e),r(n.EXPENSES_CHANGED),r(n.ACCOUNTS_CHANGED)}catch(t){console.error("Error deleting:",t),p("No se pudo eliminar el gasto",t.message),a()}},G=async e=>{const t=new Set(e.map(s=>s.rowIndex));c(s=>s.filter(l=>!t.has(l.rowIndex))),await X(e),r(n.EXPENSES_CHANGED),r(n.ACCOUNTS_CHANGED),await a()},_=async(e,t,s)=>{const l=new Set(e.map(i=>i.rowIndex));c(i=>i.map(E=>l.has(E.rowIndex)?{...E,[t]:s}:E)),await j(e,t,s),r(n.EXPENSES_CHANGED),r(n.ACCOUNTS_CHANGED),await a()};return d.jsxs(L,{onRefresh:a,disabled:f,children:[d.jsx(q,{title:"Gastos",movements:N,accounts:g,categories:S.gastos||[],loading:f,onMovementClick:u,onMovementDelete:D,onBulkDelete:G,onBulkUpdate:_,onAddClick:()=>x(!0),type:"gasto"}),m&&d.jsx(U,{movement:m,accounts:g,categories:S,onSave:y,onDelete:D,onClose:()=>u(null),onConvertedToRecurring:()=>a(!0,!1),loading:M}),d.jsx(b,{isOpen:v,onClose:()=>{x(!1),a()},defaultType:"expense"})]})}export{K as default};
